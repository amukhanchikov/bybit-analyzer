<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bybit Futures Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        .btn-loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .timeframe-btn.selected {
            background-color: #2563eb; /* blue-700 */
            color: white;
        }
        .fade-up {
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        .fade-up.visible {
            opacity: 1;
            transform: translateY(0);
        }
        #progress-bar-price {
            transition: width 0.3s ease-out;
        }
        .custom-time-active {
            box-shadow: 0 0 0 2px #2563eb; /* Equivalent to ring-2 ring-blue-600 */
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        .favorite-item:hover .delete-favorite-btn {
            opacity: 1;
        }
        /* Custom Scrollbar for Favorites */
        #favorites-list::-webkit-scrollbar {
            width: 8px;
        }
        #favorites-list::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
            border-radius: 10px;
        }
        #favorites-list::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 10px;
        }
        #favorites-list::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">Bybit Futures Analyzer</h1>
            <p class="text-gray-400">Analyze watchlists or the entire futures market</p>
        </header>
        
        <div id="price-analyzer-page">
            <div id="controls-price" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6 space-y-8"></div>
            <main id="content-area-price"></main>
        </div>

    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const Config = {
            API_BASE_URL: 'https://api.bybit.com',
            INSTRUMENTS_INFO_ENDPOINT: '/v5/market/instruments-info?category=linear',
            KLINE_ENDPOINT: '/v5/market/kline',
            TICKERS_ENDPOINT: '/v5/market/tickers',
            CACHE_DURATION_MS: 3600 * 1000, // Cache instrument list for 1 hour
            FAVORITES_STORAGE_KEY: 'bybitAnalyzer_favorites'
        };

        // --- UTILITIES ---
        const Utils = {
            getPlural: (value, unit) => `${Math.round(value)} ${Math.round(value) === 1 ? unit : unit + 's'}`,
            formatTimeframe: (totalHours) => {
                if (totalHours < 1) return Utils.getPlural(totalHours * 60, 'minute');
                if (totalHours < 24) return Utils.getPlural(totalHours, 'hour');
                return Utils.getPlural(totalHours / 24, 'day');
            },
            async processWithConcurrency(items, concurrencyLimit, processFn, progressCallback) {
                const results = [];
                const queue = [...items];
                let processedCount = 0;
                const executeTask = async () => {
                    while(queue.length > 0) {
                        const item = queue.shift();
                        if(item) {
                            try {
                                const result = await processFn(item);
                                if (result) results.push(result);
                            } catch (e) {
                                console.error(`Error processing item ${item}:`, e);
                            } finally {
                                processedCount++;
                                if (progressCallback) progressCallback(processedCount, items.length);
                            }
                        }
                    }
                };
                const workers = Array(concurrencyLimit).fill(null).map(() => executeTask());
                await Promise.all(workers);
                return results;
            }
        };

        // --- API SERVICE ---
        const ApiService = {
            async fetchInstrumentsInfo() {
                const cacheKey = 'bybitAnalyzer_instruments';
                try {
                    const cachedData = sessionStorage.getItem(cacheKey);
                    if (cachedData) {
                        const { timestamp, instruments } = JSON.parse(cachedData);
                        if (Date.now() - timestamp < Config.CACHE_DURATION_MS) {
                            return instruments;
                        }
                    }
                } catch (e) { console.error("Failed to read from sessionStorage", e); }

                let allInstruments = []; 
                let cursor = ''; 
                while (true) {
                    const url = `${Config.API_BASE_URL}${Config.INSTRUMENTS_INFO_ENDPOINT}&limit=1000${cursor ? `&cursor=${cursor}` : ''}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Bybit API Error: ${response.statusText}`);
                    const data = await response.json();
                    if (data.retCode !== 0) throw new Error(`Bybit API Response Error: ${data.retMsg}`);
                    
                    allInstruments.push(...data.result.list
                        .filter(item => item.status === 'Trading' && item.symbol.endsWith('USDT'))
                        .map(item => ({ symbol: item.symbol }))
                    );
                    
                    cursor = data.result.nextPageCursor;
                    if (!cursor) break;
                }
                
                try {
                    sessionStorage.setItem(cacheKey, JSON.stringify({ timestamp: Date.now(), instruments: allInstruments }));
                } catch (e) { console.error("Failed to save to sessionStorage", e); }

                return allInstruments;
            },
            async fetchAllTickers() {
                const url = `${Config.API_BASE_URL}${Config.TICKERS_ENDPOINT}?category=linear`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch tickers');
                const data = await response.json();
                if(data.retCode !== 0) throw new Error(`Ticker API Error: ${data.retMsg}`);
                return data.result.list;
            },
            async fetchKlineData(symbol, time, interval) {
                const url = `${Config.API_BASE_URL}${Config.KLINE_ENDPOINT}?category=linear&symbol=${symbol}&interval=${interval}&start=${time}&limit=1`;
                const response = await fetch(url);
                if (!response.ok) return null;
                const data = await response.json();
                return (data.retCode === 0 && data.result.list.length > 0) ? data.result.list[0] : null;
            }
        };

        // --- RENDERER ---
        const Renderer = {
            createCommonControlsHTML() {
                 const timeFrameControls = `
                    <div class="pb-8 border-b border-gray-700/60">
                        <h2 class="text-xl font-semibold text-white text-center mb-4">Select Timeframe</h2>
                        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-6">
                            <div class="flex items-center gap-1 p-1 bg-gray-900/50 rounded-lg">
                                <button data-hours="1" class="timeframe-btn bg-gray-700/50 hover:bg-gray-700 text-gray-300 font-semibold py-2 px-4 rounded-md transition duration-200">1h</button>
                                <button data-hours="4" class="timeframe-btn bg-gray-700/50 hover:bg-gray-700 text-gray-300 font-semibold py-2 px-4 rounded-md transition duration-200">4h</button>
                                <button data-hours="24" class="timeframe-btn selected bg-gray-700/50 hover:bg-gray-700 text-gray-300 font-semibold py-2 px-4 rounded-md transition duration-200">24h</button>
                                <button data-hours="168" class="timeframe-btn bg-gray-700/50 hover:bg-gray-700 text-gray-300 font-semibold py-2 px-4 rounded-md transition duration-200">7d</button>
                            </div>
                            <div class="text-gray-500 font-medium hidden sm:block">or</div>
                            <div class="flex items-center gap-2">
                                 <input type="number" id="custom-time-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-24 p-2.5 transition-shadow duration-200" placeholder="12">
                                 <select id="custom-time-unit" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 appearance-none text-center transition-shadow duration-200">
                                     <option value="minutes">Minutes</option>
                                     <option value="hours" selected>Hours</option>
                                     <option value="days">Days</option>
                                 </select>
                            </div>
                        </div>
                    </div>`;

                 return `
                    ${timeFrameControls}

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pt-8">
                        <!-- Full Market Analysis Card -->
                        <div class="bg-gray-700/50 p-6 rounded-lg flex flex-col">
                             <h2 class="text-2xl font-bold text-center text-white mb-4">Analyze Full Market</h2>
                             <div class="pt-2 flex-grow">
                               <label for="exclude-input" class="block mb-2 text-sm font-medium text-gray-300 text-center">Exclude tokens (comma-separated)</label>
                               <input type="text" id="exclude-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full md:w-5/6 mx-auto p-2.5" value="BTC, ETH, ETHBTC, PAXG, SOL, USDC, USDE, XAUT">
                             </div>
                             <div class="text-center mt-6">
                                <button id="analyze-market-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center gap-2 min-w-[200px] w-full sm:w-auto mx-auto">
                                    <span class="btn-text">Analyze Market</span>
                                    <span class="btn-loader-container"></span>
                                </button>
                             </div>
                        </div>

                        <!-- Watchlist Analysis Card -->
                        <div class="bg-gray-700/50 p-6 rounded-lg flex flex-col">
                             <h2 class="text-2xl font-bold text-center text-white mb-4">Analyze from File</h2>
                             <div class="flex-grow flex flex-col items-center justify-center gap-4 pt-2">
                                <label for="watchlist-upload" class="file-input-wrapper bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg cursor-pointer transition-colors duration-200 flex items-center justify-center w-full max-w-xs">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                    </svg>
                                    <span>Select JSON File</span>
                                    <input type="file" id="watchlist-upload" accept=".json"/>
                                </label>
                                <div id="file-info-container" class="hidden items-center gap-2 text-sm bg-gray-900/50 p-2 rounded-md w-full max-w-xs">
                                    <span id="file-info-name" class="text-gray-300 truncate flex-grow"></span>
                                    <button id="save-favorite-btn" title="Save to favorites" class="text-gray-400 hover:text-red-500 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-3.125L5 18V4z" />
                                        </svg>
                                    </button>
                                    <button id="clear-file-btn" title="Clear selection" class="text-gray-400 hover:text-red-500 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                           <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                       </svg>
                                   </button>
                                </div>
                             </div>
                             <div id="favorites-container" class="mt-4 pt-4 border-t border-gray-600/50">
                                <h3 class="text-sm font-semibold text-center text-gray-400 mb-2">Favorites</h3>
                                <div id="favorites-list" class="space-y-2 max-h-32 overflow-y-auto"></div>
                             </div>
                             <div class="text-center mt-6">
                                 <button id="analyze-watchlist-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center gap-2 min-w-[200px] w-full sm:w-auto disabled:bg-gray-500 disabled:cursor-not-allowed mx-auto" disabled>
                                    <span class="btn-text">Analyze Watchlist</span>
                                    <span class="btn-loader-container"></span>
                                 </button>
                             </div>
                        </div>
                    </div>
                 `;
            },
            createResultsContainerHTML(idPrefix) {
                return `
                <div id="loader-${idPrefix}" class="hidden flex-col items-center justify-center p-10">
                    <div class="loader mb-4"></div>
                    <p class="text-lg text-gray-400 mb-4">Loading data...</p>
                    <div class="w-full bg-gray-700 rounded-full h-2.5"><div id="progress-bar-${idPrefix}" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                    <p id="progress-text-${idPrefix}" class="text-sm text-gray-400 mt-2">Fetching symbols...</p>
                </div>
                <div id="error-message-${idPrefix}" class="hidden bg-red-900 border border-red-600 text-red-100 px-4 py-3 rounded-lg relative" role="alert">
                    <strong class="font-bold">Error!</strong>
                    <span class="block sm:inline" id="error-text-${idPrefix}"></span>
                </div>
                <!-- Container for all results -->
                <div id="results-dashboard-${idPrefix}" class="hidden"></div>
                `;
            },
        };

        // --- ANALYZER CLASS ---
        class PriceAnalyzer {
            constructor(id) {
                this.id = id;
                this.isRunning = false;
                this.watchlists = null;
                this.currentFileName = null;
                this.controlsContainer = document.getElementById(`controls-${id}`);
                this.contentContainer = document.getElementById(`content-area-${id}`);
            }

            getUI() {
                return {
                    showLoader: () => document.getElementById(`loader-${this.id}`).classList.replace('hidden', 'flex'),
                    hideLoader: () => document.getElementById(`loader-${this.id}`).classList.replace('flex', 'hidden'),
                    showError: (message) => {
                        document.getElementById(`error-message-${this.id}`).classList.remove('hidden');
                        document.getElementById(`error-text-${this.id}`).textContent = message;
                        document.getElementById(`results-dashboard-${this.id}`).classList.add('hidden');
                    },
                    hideError: () => document.getElementById(`error-message-${this.id}`).classList.add('hidden'),
                    showResults: () => {
                         const dashboard = document.getElementById(`results-dashboard-${this.id}`);
                         dashboard.classList.remove('hidden');
                         dashboard.querySelectorAll('.result-card').forEach((el, index) => {
                            el.classList.add('fade-up');
                            setTimeout(() => el.classList.add('visible'), index * 50);
                         });
                    }
                }
            }
            
            getProgress() {
                 return {
                    update: (current, total, text) => {
                        const percent = total > 0 ? (current / total) * 100 : 0;
                        document.getElementById(`progress-bar-${this.id}`).style.width = `${percent}%`;
                        document.getElementById(`progress-text-${this.id}`).textContent = text || `Processing ${current} / ${total}...`;
                    }
                }
            }

            setButtonLoading(isLoading, button) {
                if (!button) return;
                const text = button.querySelector('.btn-text');
                const loaderContainer = button.querySelector('.btn-loader-container');
                button.disabled = isLoading;
                if (text) text.style.display = isLoading ? 'none' : 'inline';
                if (loaderContainer) loaderContainer.innerHTML = isLoading ? '<div class="btn-loader"></div>' : '';
            }

            async runAnalysis(mode, triggerButton) {
                if (this.isRunning) return;
                
                this.isRunning = true;
                this.setButtonLoading(true, triggerButton);
                this.getUI().hideError();
                this.getUI().showLoader();

                try {
                    const hours = this.getSelectedTimeframe();
                    if (isNaN(hours)) throw new Error("Invalid timeframe selected.");

                    let symbolsToFetch;
                    if (mode === 'watchlist') {
                        if (!this.watchlists) throw new Error("No watchlist file loaded.");
                        const longSymbols = Object.keys(this.watchlists.long_watchlist || {});
                        const shortSymbols = Object.keys(this.watchlists.short_watchlist || {});
                        symbolsToFetch = [...new Set([...longSymbols, ...shortSymbols])];
                        if (symbolsToFetch.length === 0) throw new Error("No symbols found in the provided watchlists.");
                    } else { // full_market
                        this.getProgress().update(0, 1, "Fetching instrument list...");
                        const instruments = await ApiService.fetchInstrumentsInfo();
                        const excluded = document.getElementById('exclude-input').value.toUpperCase().split(',').map(t => t.trim()).filter(Boolean);
                        symbolsToFetch = instruments.map(i => i.symbol).filter(s => !excluded.includes(s.replace('USDT', '')));
                    }

                    const allValidResults = await this.fetchAndProcessTokenData(symbolsToFetch, { hours });
                    if (allValidResults.length === 0) throw new Error(`No data available for the selected period.`);

                    const ignoredCount = symbolsToFetch.length - allValidResults.length;
                    this.render(allValidResults, { hours, mode, ignoredCount });
                    this.getUI().showResults();

                } catch (error) {
                    console.error(`Analysis Error:`, error);
                    this.getUI().showError(error.message);
                } finally {
                    this.setButtonLoading(false, triggerButton);
                    this.getUI().hideLoader();
                    this.isRunning = false;
                }
            }
            
            async fetchAndProcessTokenData(symbols, { hours }) {
                const progress = this.getProgress();
                const now = new Date();
                const startTime = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), now.getUTCHours(), now.getUTCMinutes()) - (hours * 3600 * 1000);
                
                const klineInterval = (hours <= 24) ? '1' : (hours <= 720) ? '60' : 'D';

                progress.update(0, 1, 'Fetching current prices...');
                const tickersMap = new Map((await ApiService.fetchAllTickers()).map(t => [t.symbol, t.lastPrice]));
                
                progress.update(0, symbols.length, `Fetching historical prices for ${symbols.length} tokens...`);
                
                return await Utils.processWithConcurrency(symbols, 30, async (symbol) => {
                    const endPriceStr = tickersMap.get(symbol);
                    if (!endPriceStr) return null;
                    const startPriceData = await ApiService.fetchKlineData(symbol, startTime, klineInterval);
                    if (!startPriceData) return null;
                    
                    const startTimestampFromServer = parseInt(startPriceData[0], 10);
                    let tolerance;
                    switch (klineInterval) {
                        case '1': tolerance = 1 * 60 * 1000 * 5; break; // 5 minutes for 1m interval
                        case '60': tolerance = 60 * 60 * 1000 * 2; break; // 2 hours for 1h interval
                        case 'D': tolerance = 24 * 60 * 60 * 1000 * 2; break; // 2 days for daily interval
                        default: tolerance = 60 * 60 * 1000; // 1 hour default
                    }
                    if (startTimestampFromServer > startTime + tolerance) {
                        return null;
                    }

                    const startPrice = parseFloat(startPriceData[4]);
                    const endPrice = parseFloat(endPriceStr);
                    if (startPrice === 0) return null;
                    
                    const change = ((endPrice - startPrice) / startPrice) * 100;
                    return { symbol, change: parseFloat(change.toFixed(2)), startPrice: startPrice.toFixed(4), endPrice: endPrice.toFixed(4) };
                }, (current, total) => progress.update(current, total));
            }

            calculateStatsForList(listSymbols, allResults, limit = 5) {
                const filteredResults = allResults.filter(r => listSymbols.includes(r.symbol));
                if (filteredResults.length === 0) return { count: 0, averageReturn: '0.00', medianReturn: '0.00', top: [], bottom: [] };
                
                filteredResults.sort((a, b) => b.change - a.change);
                const changes = filteredResults.map(r => r.change);
                const sum = changes.reduce((a, v) => a + v, 0);
                const average = sum / changes.length;
                const sortedChanges = [...changes].sort((a, b) => a - b);
                const midIndex = Math.floor(changes.length / 2);
                const median = changes.length % 2 === 0 ? (sortedChanges[midIndex - 1] + sortedChanges[midIndex]) / 2 : sortedChanges[midIndex];
                
                return {
                    count: filteredResults.length,
                    averageReturn: average.toFixed(2),
                    medianReturn: median.toFixed(2),
                    top: filteredResults.slice(0, limit),
                    bottom: filteredResults.slice(-limit).sort((a, b) => a.change - b.change)
                };
            }
            
            render(results, { hours, mode, ignoredCount }) {
                const dashboard = document.getElementById(`results-dashboard-${this.id}`);
                if (mode === 'watchlist') {
                    const longSymbols = Object.keys(this.watchlists.long_watchlist || {});
                    const shortSymbols = Object.keys(this.watchlists.short_watchlist || {});
                    
                    const longResults = results.filter(r => longSymbols.includes(r.symbol));
                    const shortResults = results.filter(r => shortSymbols.includes(r.symbol));
                    const longIgnored = longSymbols.length - longResults.length;
                    const shortIgnored = shortSymbols.length - shortResults.length;

                    const longStats = this.calculateStatsForList(longSymbols, results, 5);
                    const shortStats = this.calculateStatsForList(shortSymbols, results, 5);

                    dashboard.innerHTML = `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-6">${this.createListResultHTML('Long Watchlist', longStats, hours, longIgnored)}</div>
                            <div class="space-y-6">${this.createListResultHTML('Short Watchlist', shortStats, hours, shortIgnored)}</div>
                        </div>`;
                } else { // full_market
                    const stats = this.calculateStatsForList(results.map(r => r.symbol), results, 10);
                    dashboard.innerHTML = this.createFullMarketResultHTML(stats, hours, ignoredCount);
                }
            }

            createFullMarketResultHTML(stats, hours, ignoredCount) {
                const avgColor = stats.averageReturn >= 0 ? 'text-green-500' : 'text-red-500';
                const medColor = stats.medianReturn >= 0 ? 'text-green-500' : 'text-red-500';

                const summaryHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg result-card">
                        <h3 class="text-xl font-semibold text-white mb-4">Market Summary</h3>
                        <p class="text-sm text-gray-400 mb-4">For the last ${Utils.formatTimeframe(hours)} (Exclusions Applied)</p>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                            <div><p class="text-sm text-gray-400">Analyzed</p><p class="text-2xl font-bold text-white">${stats.count}</p></div>
                            <div><p class="text-sm text-gray-400">Ignored</p><p class="text-2xl font-bold text-gray-500">${ignoredCount}</p></div>
                            <div><p class="text-sm text-gray-400">Avg. Return</p><p class="text-2xl font-bold ${avgColor}">${stats.averageReturn}%</p></div>
                            <div><p class="text-sm text-gray-400">Median</p><p class="text-2xl font-bold ${medColor}">${stats.medianReturn}%</p></div>
                        </div>
                    </div>`;

                 const topHTML = this.createTableHTML('🚀 Top 10 Gainers', stats.top);
                 const bottomHTML = this.createTableHTML('📉 Top 10 Losers', stats.bottom);

                 return `<div class="space-y-6">${summaryHTML}<div class="grid grid-cols-1 md:grid-cols-2 gap-6">${topHTML}${bottomHTML}</div></div>`;
            }

            createListResultHTML(title, stats, hours, ignoredCount) {
                if (stats.count === 0 && ignoredCount === 0) return `<div class="bg-gray-800 p-6 rounded-lg shadow-lg result-card"><h3 class="text-xl font-semibold text-white mb-4">${title}</h3><p class="text-gray-400">No tokens found in this list.</p></div>`;

                const avgColor = stats.averageReturn >= 0 ? 'text-green-500' : 'text-red-500';
                const medColor = stats.medianReturn >= 0 ? 'text-green-500' : 'text-red-500';

                const summaryHTML = `
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg result-card">
                        <h3 class="text-xl font-semibold text-white mb-4">${title} Summary</h3>
                        <p class="text-sm text-gray-400 mb-4">For the last ${Utils.formatTimeframe(hours)}</p>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                            <div><p class="text-sm text-gray-400">Analyzed</p><p class="text-2xl font-bold text-white">${stats.count}</p></div>
                            <div><p class="text-sm text-gray-400">Ignored</p><p class="text-2xl font-bold text-gray-500">${ignoredCount}</p></div>
                            <div><p class="text-sm text-gray-400">Avg.</p><p class="text-2xl font-bold ${avgColor}">${stats.averageReturn}%</p></div>
                            <div><p class="text-sm text-gray-400">Median</p><p class="text-2xl font-bold ${medColor}">${stats.medianReturn}%</p></div>
                        </div>
                    </div>`;

                return `${summaryHTML}${this.createTableHTML('🚀 Top 5 Gainers', stats.top)}${this.createTableHTML('📉 Top 5 Losers', stats.bottom)}`;
            }

            createTableHTML(tableTitle, data) {
                 if (data.length === 0) return '';
                 const tableRows = data.map(item => `
                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                        <th class="px-4 py-3 font-medium text-white"><a href="https://www.bybit.com/trade/usdt/${item.symbol}" target="_blank" class="hover:underline">${item.symbol}</a></th>
                        <td class="px-4 py-3 text-right font-bold ${item.change >= 0 ? 'text-green-500' : 'text-red-500'}">${item.change >= 0 ? '+' : ''}${item.change}%</td>
                    </tr>`).join('');

                 return `<div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden result-card">
                            <table class="w-full text-sm text-left text-gray-400">
                                <caption class="p-4 text-lg font-semibold text-left text-white bg-gray-700/50">${tableTitle}</caption>
                                <thead class="text-xs text-gray-300 uppercase bg-gray-700"><tr><th class="px-4 py-2">Symbol</th><th class="px-4 py-2 text-right">Change</th></tr></thead>
                                <tbody>${tableRows}</tbody>
                            </table>
                        </div>`;
            }

            getSelectedTimeframe() {
                const selectedBtn = this.controlsContainer.querySelector(`.timeframe-btn.selected`);
                if (selectedBtn) {
                    return parseInt(selectedBtn.dataset.hours, 10);
                }
                
                const value = parseFloat(document.getElementById(`custom-time-input`).value);
                if (isNaN(value) || value <= 0) {
                    return NaN;
                }
                
                const unit = document.getElementById(`custom-time-unit`).value;
                return unit === 'minutes' ? value / 60 : (unit === 'days' ? value * 24 : value);
            }

            // --- Favorites Logic ---
            getFavorites() {
                try {
                    return JSON.parse(localStorage.getItem(Config.FAVORITES_STORAGE_KEY)) || [];
                } catch (e) {
                    return [];
                }
            }

            saveFavorite() {
                if (!this.currentFileName || !this.watchlists) return;
                const favorites = this.getFavorites();
                const existingIndex = favorites.findIndex(fav => fav.name === this.currentFileName);
                const newFav = { name: this.currentFileName, data: this.watchlists };
                
                if (existingIndex > -1) {
                    favorites[existingIndex] = newFav; // Update existing
                } else {
                    favorites.push(newFav);
                }
                localStorage.setItem(Config.FAVORITES_STORAGE_KEY, JSON.stringify(favorites));
                this.renderFavorites();
            }

            deleteFavorite(name) {
                let favorites = this.getFavorites();
                favorites = favorites.filter(fav => fav.name !== name);
                localStorage.setItem(Config.FAVORITES_STORAGE_KEY, JSON.stringify(favorites));
                this.renderFavorites();
            }

            loadFavorite(name) {
                const favorites = this.getFavorites();
                const favorite = favorites.find(fav => fav.name === name);
                if (favorite) {
                    this.watchlists = favorite.data;
                    this.currentFileName = favorite.name;
                    
                    document.getElementById('file-info-name').textContent = this.currentFileName;
                    
                    const fileInfoContainer = document.getElementById('file-info-container');
                    fileInfoContainer.classList.remove('hidden');
                    fileInfoContainer.classList.add('flex');

                    document.getElementById('analyze-watchlist-btn').disabled = false;
                    document.querySelector('label[for="watchlist-upload"]').classList.add('hidden');
                }
            }

            renderFavorites() {
                const favorites = this.getFavorites();
                const container = document.getElementById('favorites-list');
                const favoritesContainer = document.getElementById('favorites-container');
                container.innerHTML = '';

                if (favorites.length === 0) {
                    favoritesContainer.classList.add('hidden');
                    return;
                }
                favoritesContainer.classList.remove('hidden');

                favorites.forEach(fav => {
                    const div = document.createElement('div');
                    div.className = 'favorite-item flex items-center justify-between bg-gray-900/50 p-2 rounded-md';
                    div.innerHTML = `
                        <button class="text-left text-blue-400 hover:underline truncate flex-grow" data-name="${fav.name}">${fav.name}</button>
                        <button class="delete-favorite-btn text-gray-500 hover:text-red-500 transition-all opacity-0 ml-2" data-name="${fav.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    container.appendChild(div);
                });
            }


            bindEvents() {
                const analyzeWatchlistBtn = document.getElementById('analyze-watchlist-btn');
                const analyzeMarketBtn = document.getElementById('analyze-market-btn');
                const fileInput = document.getElementById('watchlist-upload');
                const customTimeInput = document.getElementById('custom-time-input');
                const customTimeUnit = document.getElementById('custom-time-unit');
                const fileInfoContainer = document.getElementById('file-info-container');
                const fileInfoName = document.getElementById('file-info-name');
                const saveFavoriteBtn = document.getElementById('save-favorite-btn');
                const favoritesList = document.getElementById('favorites-list');
                const clearFileBtn = document.getElementById('clear-file-btn');

                const setActiveCustomTime = () => {
                    this.controlsContainer.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('selected'));
                    customTimeInput.classList.add('custom-time-active');
                    customTimeUnit.classList.add('custom-time-active');
                };

                const clearActiveCustomTime = () => {
                    customTimeInput.classList.remove('custom-time-active');
                    customTimeUnit.classList.remove('custom-time-active');
                };
                
                this.controlsContainer.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (target && target.matches('.timeframe-btn')) {
                        this.controlsContainer.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('selected'));
                        target.classList.add('selected');
                        customTimeInput.value = '';
                        clearActiveCustomTime();
                    }
                });
                
                customTimeInput.addEventListener('focus', setActiveCustomTime);
                customTimeInput.addEventListener('input', setActiveCustomTime);
                customTimeUnit.addEventListener('change', setActiveCustomTime);

                const resetFileSelection = () => {
                    this.watchlists = null;
                    this.currentFileName = null;
                    fileInput.value = ''; // Important to allow re-selecting the same file

                    fileInfoContainer.classList.add('hidden');
                    fileInfoContainer.classList.remove('flex');

                    document.querySelector('label[for="watchlist-upload"]').classList.remove('hidden');
                    
                    analyzeWatchlistBtn.disabled = true;
                };

                clearFileBtn.addEventListener('click', resetFileSelection);

                fileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            this.watchlists = JSON.parse(e.target.result);
                            this.currentFileName = file.name;
                            this.getUI().hideError();
                            analyzeWatchlistBtn.disabled = false;
                            
                            document.querySelector('label[for="watchlist-upload"]').classList.add('hidden');
                            fileInfoName.textContent = file.name;
                            fileInfoContainer.classList.remove('hidden');
                            fileInfoContainer.classList.add('flex');
                            
                        } catch (err) {
                            this.watchlists = null;
                            this.currentFileName = null;
                            this.getUI().showError('Failed to parse JSON file.');
                            analyzeWatchlistBtn.disabled = true;
                            fileInfoContainer.classList.add('hidden');
                        }
                    };
                    reader.readAsText(file);
                });
                
                saveFavoriteBtn.addEventListener('click', () => this.saveFavorite());

                favoritesList.addEventListener('click', (e) => {
                    const loadBtn = e.target.closest('button[data-name]');
                    if (!loadBtn) return;

                    if (loadBtn.classList.contains('delete-favorite-btn')) {
                        this.deleteFavorite(loadBtn.dataset.name);
                    } else {
                        this.loadFavorite(loadBtn.dataset.name);
                    }
                });

                analyzeWatchlistBtn.addEventListener('click', () => this.runAnalysis('watchlist', analyzeWatchlistBtn));
                analyzeMarketBtn.addEventListener('click', () => this.runAnalysis('full_market', analyzeMarketBtn));
                
                this.renderFavorites(); // Initial render
            }
        }
        
        // --- APP INITIALIZATION ---
        const App = {
            init() {
                document.getElementById('controls-price').innerHTML = Renderer.createCommonControlsHTML();
                document.getElementById('content-area-price').innerHTML = Renderer.createResultsContainerHTML('price');
                const analyzer = new PriceAnalyzer('price');
                analyzer.bindEvents();
            }
        };

        App.init();

    </script>
</body>
</html>

