<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализатор фьючерсов Bybit (Статистика)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .timeframe-btn.selected {
            background-color: #2563eb; /* blue-700 */
            outline: 2px solid #3b82f6; /* blue-500 */
            outline-offset: 2px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">Статистический анализатор фьючерсов Bybit</h1>
            <p class="text-gray-400">Выберите таймфрейм для анализа рыночной статистики</p>
        </header>

        <!-- Панель управления -->
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6">
            <div class="flex flex-wrap justify-center items-center gap-3 mb-4">
                <span class="font-medium mr-4">Быстрый выбор:</span>
                <button data-hours="1" class="timeframe-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">1 час</button>
                <button data-hours="4" class="timeframe-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">4 часа</button>
                <button data-hours="24" class="timeframe-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">24 часа</button>
                <button data-hours="168" class="timeframe-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">7 дней</button>
            </div>
             <!-- Пользовательский таймфрейм -->
            <div class="mt-4 pt-4 border-t border-gray-700 flex flex-wrap justify-center items-center gap-2">
                 <input type="number" id="custom-time-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-24 p-2.5" placeholder="12">
                 <select id="custom-time-unit" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                     <option value="minutes">Минут</option>
                     <option value="hours" selected>Часов</option>
                     <option value="days">Дней</option>
                 </select>
                 <button id="custom-time-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-md transition duration-300">Анализ</button>
            </div>
             <!-- Поле для исключения токенов -->
            <div class="mt-4 pt-4 border-t border-gray-700">
                <label for="exclude-input" class="block mb-2 text-sm font-medium text-gray-300 text-center">Исключить токены (через запятую)</label>
                <input type="text" id="exclude-input" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full md:w-2/3 mx-auto p-2.5" value="BTC, ETH, ETHBTC, PAXG, SOL, USDC, USDE, XAUT">
            </div>
        </div>


        <!-- Область для отображения результатов -->
        <main id="content-area">
            <div id="loader" class="hidden flex-col items-center justify-center p-10">
                <div class="loader mb-4"></div>
                <p class="text-lg text-gray-400">Загрузка данных... Это может занять некоторое время.</p>
            </div>
            <div id="error-message" class="hidden bg-red-900 border border-red-600 text-red-100 px-4 py-3 rounded-lg relative" role="alert">
                <strong class="font-bold">Ошибка!</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>
            
            <!-- Контейнер для статистики и таблиц -->
            <div id="results-dashboard" class="hidden">
                <!-- Ключевые активы -->
                <div id="key-tokens-container" class="mb-6"></div>
                
                <!-- Сводная статистика -->
                <div id="summary-stats" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6"></div>

                <!-- Таблицы Top/Bottom -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div id="top-10-container" class="bg-gray-800 rounded-lg shadow-lg overflow-hidden"></div>
                    <div id="bottom-10-container" class="bg-gray-800 rounded-lg shadow-lg overflow-hidden"></div>
                </div>

            </div>
        </main>
    </div>

    <script type="module">
        // --- DOM Элементы ---
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const timeframeButtons = document.querySelectorAll('.timeframe-btn');
        const excludeInput = document.getElementById('exclude-input');
        const customTimeInput = document.getElementById('custom-time-input');
        const customTimeUnit = document.getElementById('custom-time-unit');
        const customTimeBtn = document.getElementById('custom-time-btn');
        const resultsDashboard = document.getElementById('results-dashboard');
        const summaryStatsContainer = document.getElementById('summary-stats');
        const keyTokensContainer = document.getElementById('key-tokens-container');
        const top10Container = document.getElementById('top-10-container');
        const bottom10Container = document.getElementById('bottom-10-container');

        // --- Bybit API Константы ---
        const API_BASE_URL = 'https://api.bybit.com';
        const INSTRUMENTS_INFO_ENDPOINT = '/v5/market/instruments-info?category=linear';
        const KLINE_ENDPOINT = '/v5/market/kline';

        // --- Основная логика ---

        function getExcludedTokens() {
            if (!excludeInput.value) return [];
            return excludeInput.value
                .toUpperCase()
                .split(',')
                .map(token => token.trim())
                .filter(token => token.length > 0);
        }
        
        function handlePresetTimeframeClick(event) {
            updateSelectedButton(event.currentTarget);
            const hours = parseInt(event.currentTarget.getAttribute('data-hours'));
            runAnalysis(hours);
        }
        
        function handleCustomTimeframeClick() {
            updateSelectedButton(null); // Сбрасываем выделение с кнопок
            const value = parseFloat(customTimeInput.value);
            if (isNaN(value) || value <= 0) {
                 showError("Пожалуйста, введите корректное число для таймфрейма.");
                 return;
            }
            const unit = customTimeUnit.value;
            let hours = 0;
            switch(unit) {
                case 'minutes':
                    hours = value / 60;
                    break;
                case 'hours':
                    hours = value;
                    break;
                case 'days':
                    hours = value * 24;
                    break;
            }
            runAnalysis(hours);
        }

        async function runAnalysis(hours) {
            if (isNaN(hours) || hours <= 0) return;

            showLoader();

            try {
                const endTime = new Date().getTime();
                const startTime = endTime - (hours * 60 * 60 * 1000);

                const allSymbols = await fetchAllSymbols();
                if (!allSymbols || allSymbols.length === 0) {
                    throw new Error("Не удалось получить список торговых пар.");
                }

                const priceChangePromises = allSymbols.map(symbol => getPriceChangeForSymbol(symbol, startTime, endTime));
                const results = await Promise.allSettled(priceChangePromises);
                
                const allValidResults = results
                    .filter(result => result.status === 'fulfilled' && result.value !== null)
                    .map(result => result.value);

                if (allValidResults.length === 0) {
                    throw new Error(`Нет данных для указанного периода.`);
                }

                const keySymbols = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT'];
                const keyTokenData = keySymbols
                    .map(symbol => allValidResults.find(r => r.symbol === symbol))
                    .filter(Boolean);

                const excludedTokens = getExcludedTokens();
                const filteredResults = allValidResults.filter(result => {
                    const baseTicker = result.symbol.replace('USDT', '');
                    return !excludedTokens.includes(baseTicker);
                });

                if (filteredResults.length === 0) {
                    renderDashboard({ count: 0, averageReturn: '0.00', medianReturn: '0.00' }, [], [], keyTokenData, hours);
                    return;
                }
                
                filteredResults.sort((a, b) => b.change - a.change);
                
                const stats = calculateStatistics(filteredResults);
                const top10 = filteredResults.slice(0, 10);
                const bottom10 = filteredResults.slice(-10).reverse();

                renderDashboard(stats, top10, bottom10, keyTokenData, hours);

            } catch (error) {
                console.error("Произошла ошибка:", error);
                showError(error.message);
            } finally {
                hideLoader();
            }
        }
        
        function calculateStatistics(results) {
            const changes = results.map(r => r.change);
            const total = changes.length;
            if (total === 0) {
                return { count: 0, averageReturn: '0.00', medianReturn: '0.00' };
            }
            const sum = changes.reduce((acc, val) => acc + val, 0);
            const average = sum / total;
            const sortedChanges = [...changes].sort((a, b) => a - b);
            const midIndex = Math.floor(total / 2);
            const median = total % 2 === 0 ? (sortedChanges[midIndex - 1] + sortedChanges[midIndex]) / 2 : sortedChanges[midIndex];
            
            return { count: total, averageReturn: average.toFixed(2), medianReturn: median.toFixed(2) };
        }

        async function fetchAllSymbols() {
            let allSymbols = [];
            let cursor = '';
            const limit = 1000;
            while (true) {
                const url = `${API_BASE_URL}${INSTRUMENTS_INFO_ENDPOINT}&limit=${limit}${cursor ? `&cursor=${cursor}` : ''}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Ошибка API Bybit: ${response.statusText}`);
                const data = await response.json();
                if (data.retCode !== 0) throw new Error(`Ошибка в ответе API Bybit: ${data.retMsg}`);
                const symbolsOnPage = data.result.list
                    .filter(item => item.status === 'Trading' && item.symbol.endsWith('USDT'))
                    .map(item => item.symbol);
                allSymbols = allSymbols.concat(symbolsOnPage);
                cursor = data.result.nextPageCursor;
                if (!cursor) break;
            }
            return allSymbols;
        }

        async function getPriceChangeForSymbol(symbol, startTime, endTime) {
            try {
                const startPriceData = await fetchKlineData(symbol, startTime);
                const endPriceData = await fetchKlineData(symbol, endTime, true);
                if (!startPriceData || !endPriceData) return null;
                const startPrice = parseFloat(startPriceData[4]);
                const endPrice = parseFloat(endPriceData[4]);
                if (startPrice === 0) return null;
                const change = ((endPrice - startPrice) / startPrice) * 100;
                const pricePrecision = Math.max(2, (startPrice.toString().split('.')[1] || '').length);
                return { symbol, startPrice: startPrice.toFixed(pricePrecision), endPrice: endPrice.toFixed(pricePrecision), change: parseFloat(change.toFixed(2)) };
            } catch (error) { return null; }
        }

        async function fetchKlineData(symbol, time, isEndTime = false) {
            const interval = '1';
            let url = `${API_BASE_URL}${KLINE_ENDPOINT}?category=linear&symbol=${symbol}&interval=${interval}&limit=1`;
            url += isEndTime ? `&end=${time}` : `&start=${time}`;
            const response = await fetch(url);
            if (!response.ok) return null;
            const data = await response.json();
            return (data.retCode === 0 && data.result.list && data.result.list.length > 0) ? data.result.list[0] : null;
        }

        // --- Функции для управления UI ---
        function renderDashboard(stats, top10, bottom10, keyTokenData, hours) {
            renderKeyTokens(keyTokenData);
            renderSummaryStats(stats, hours);
            top10Container.innerHTML = createChangeTable('🚀 Топ-10 роста', top10);
            bottom10Container.innerHTML = createChangeTable('📉 Топ-10 падения', bottom10);
            resultsDashboard.classList.remove('hidden');
        }

        function renderSummaryStats(stats, hours) {
            const avgColor = stats.averageReturn >= 0 ? 'text-green-500' : 'text-red-500';
            const medColor = stats.medianReturn >= 0 ? 'text-green-500' : 'text-red-500';
            summaryStatsContainer.innerHTML = `
                <h3 class="text-xl font-semibold text-white mb-4">Сводка по рынку за ${formatTimeframe(hours)} (без исключенных)</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div><p class="text-sm text-gray-400">Проанализировано токенов</p><p class="text-2xl font-bold text-white">${stats.count}</p></div>
                    <div><p class="text-sm text-gray-400">Average Return</p><p class="text-2xl font-bold ${avgColor}">${stats.averageReturn}%</p></div>
                    <div><p class="text-sm text-gray-400">Median Return</p><p class="text-2xl font-bold ${medColor}">${stats.medianReturn}%</p></div>
                </div>`;
        }
        
        function renderKeyTokens(keyTokenData) {
            if (!keyTokenData || keyTokenData.length === 0) {
                keyTokensContainer.innerHTML = '';
                return;
            }

            const cardsHTML = keyTokenData.map(item => {
                const color = item.change >= 0 ? 'text-green-500' : 'text-red-500';
                const sign = item.change >= 0 ? '+' : '';
                return `
                    <div class="bg-gray-700 p-4 rounded-lg flex justify-between items-center shadow-lg">
                        <div>
                            <p class="text-lg font-bold text-white">${item.symbol.replace('USDT', '')}</p>
                            <p class="text-xs text-gray-400">${item.startPrice} → ${item.endPrice}</p>
                        </div>
                        <p class="text-xl font-bold ${color}">${sign}${item.change}%</p>
                    </div>
                `;
            }).join('');

            keyTokensContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    ${cardsHTML}
                </div>
            `;
        }

        function createChangeTable(title, data) {
            if (data.length === 0) return `<div class="bg-gray-800 rounded-lg shadow-lg p-4 text-center text-gray-500">${title}<br><br>Нет данных для отображения.</div>`;
            const tableRows = data.map(item => `
                <tr class="bg-gray-800 border-b border-gray-700 hover:bg-gray-700/50">
                    <th scope="row" class="px-4 py-3 font-medium text-white whitespace-nowrap">
                        <div>${item.symbol}</div><div class="text-xs text-gray-500">${item.startPrice} → ${item.endPrice}</div>
                    </th>
                    <td class="px-4 py-3 text-right font-bold ${item.change >= 0 ? 'text-green-500' : 'text-red-500'}">${item.change >= 0 ? '+' : ''}${item.change}%</td>
                </tr>`).join('');
            return `<table class="w-full text-sm text-left text-gray-400">
                    <caption class="p-4 text-lg font-semibold text-left text-white bg-gray-700/50">${title}</caption>
                    <thead class="text-xs text-gray-300 uppercase bg-gray-700"><tr><th scope="col" class="px-4 py-2">Символ</th><th scope="col" class="px-4 py-2 text-right">Изменение</th></tr></thead>
                    <tbody>${tableRows}</tbody></table>`;
        }

        function showLoader() {
            loader.classList.remove('hidden');
            loader.classList.add('flex');
            resultsDashboard.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }

        function hideLoader() {
            loader.classList.add('hidden');
            loader.classList.remove('flex');
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            resultsDashboard.classList.add('hidden');
        }
        
        function updateSelectedButton(selectedBtn) {
            timeframeButtons.forEach(btn => {
                btn.classList.remove('selected');
            });
            if(selectedBtn) {
                selectedBtn.classList.add('selected');
            }
        }

        function formatTimeframe(totalHours) {
            if (totalHours < 1) {
                const minutes = Math.round(totalHours * 60);
                return `${minutes} ${getMinuteWord(minutes)}`;
            }
            if (totalHours < 24) {
                 return `${totalHours} ${getHourWord(totalHours)}`;
            }
            const days = totalHours / 24;
            return `${days} ${getDayWord(days)}`;
        }

        function getMinuteWord(n) {
            const cases = [2, 0, 1, 1, 1, 2];
            const titles = ['минуту', 'минуты', 'минут'];
            return titles[(n % 100 > 4 && n % 100 < 20) ? 2 : cases[(n % 10 < 5) ? n % 10 : 5]];
        }
        function getHourWord(n) {
            const cases = [2, 0, 1, 1, 1, 2];
            const titles = ['час', 'часа', 'часов'];
            return titles[(n % 100 > 4 && n % 100 < 20) ? 2 : cases[(n % 10 < 5) ? n % 10 : 5]];
        }
         function getDayWord(n) {
            const cases = [2, 0, 1, 1, 1, 2];
            const titles = ['день', 'дня', 'дней'];
            return titles[(n % 100 > 4 && n % 100 < 20) ? 2 : cases[(n % 10 < 5) ? n % 10 : 5]];
        }


        // --- Назначение обработчиков событий ---
        timeframeButtons.forEach(button => button.addEventListener('click', handlePresetTimeframeClick));
        customTimeBtn.addEventListener('click', handleCustomTimeframeClick);

    </script>
</body>
</html>
